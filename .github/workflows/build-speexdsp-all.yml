name: Build SpeexDSP (Linux + macOS baseline)

on:
  workflow_dispatch:

jobs:
  # ==========================
  # Linux (x64 + arm64)
  # ==========================
  linux:
    strategy:
      matrix:
        include:
          - runner: ubuntu-24.04
            outdir: linux-x64
          - runner: ubuntu-24.04-arm
            outdir: linux-arm64

    runs-on: ${{ matrix.runner }}

    steps:
      - uses: actions/checkout@v4

      - name: Install build deps
        run: |
          sudo apt update
          sudo apt install -y \
            autoconf automake libtool pkg-config build-essential

      # SpeexDSP from git: autogen.sh THEN configure
      - name: Autogen & configure
        run: |
          ./autogen.sh
          ./configure --enable-shared --disable-static

      - name: Build
        run: |
          make -j"$(nproc)"

      - name: Collect artifact
        run: |
          mkdir -p artifacts/${{ matrix.outdir }}
          cp libspeexdsp/.libs/libspeexdsp.so artifacts/${{ matrix.outdir }}/

      - uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.outdir }}
          path: artifacts/${{ matrix.outdir }}/

  # ==========================
  # macOS (Intel + ARM)
  # ==========================
  macos:
    strategy:
      matrix:
        include:
          - runner: macos-15-intel
            outdir: darwin-x64
          - runner: macos-15
            outdir: darwin-arm64

    runs-on: ${{ matrix.runner }}

    steps:
      - uses: actions/checkout@v4

      - name: Install build deps
        run: |
          brew install autoconf automake libtool

      - name: Autogen & configure
        run: |
          ./autogen.sh
          ./configure --enable-shared --disable-static

      - name: Build
        run: |
          make -j"$(sysctl -n hw.ncpu)"

      - name: Collect artifact
        run: |
          mkdir -p artifacts/${{ matrix.outdir }}
          cp libspeexdsp/.libs/libspeexdsp.dylib artifacts/${{ matrix.outdir }}/

      - uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.outdir }}
          path: artifacts/${{ matrix.outdir }}/
